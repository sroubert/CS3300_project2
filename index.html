<!DOCTYPE html>

<html>

<!-- sr949, dc652, kat86 Project 2 -->

<head>

    <meta charset="utf-8">
    <!-- Weather icons from http://www.freepik.com and https://www.amcharts.com/free-animated-svg-weather-icons/ -->
    <title>CS 3300 Project 2</title>

    <link type="text/css" rel="stylesheet" href="https://fast.fonts.net/cssapi/c1ece602-4b8f-4767-a71f-aa828be38869.css" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="Datejs-master/build/date.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

    <style>
        body {
            font-family: "LinotypeUniversW01-Cn";
            padding: 10px 0;
            background-color: #eeeeee;
        }
        
        h1 {
            font-family: "LinotypeUniversW01-Cn";
            text-transform: uppercase;
            font-weight: 600;
            font-size: 35pt;
            padding: 0;
            margin: 0;
            padding-top: 10px;
            line-height: 1.2em;
            text-align: center;
        }
        
        h2 {
            text-align: left;
            padding-top: 10px;
        }
        
        h3 {
            font-family: "LinotypeUniversW01-Cn";
            text-transform: uppercase;
            font-weight: 500;
            font-size: 25pt;
        }
        
        p {
            font-size: 15pt;
        }
        
        #highlight {
            color: #667f39;
            font-weight: 600;
        }
        
        #instruct {
            text-align: left;
            padding-left: 10px;
            padding-bottom: 0;
        }
        
        div.circle {
            width: 40px;
            height: 40px;
            border: solid #585858 2px;
            border-radius: 30px;
            color: #585858;
            text-align: center;
            font-size: 32px;
            margin: 23px 20px 0 0;
            float: left;
            font-weight: bold;
        }
        
        div.circleText {
            padding-top: 3px;
        }

        input {
            padding: 3px;
            font-size: 12pt;
        }

        button {
            border: solid #585858 1px;
            color: #585858;
            background-color: white;
            text-align: center;
            font-family: "LinotypeUniversW01-Cn";
            font-weight: 600;
            font-size: 15pt;
            padding: 5px;
            margin-left: 30px;
            padding-left: 15px;
            padding-right: 15px;
        }

        button:hover {
            background-color: #848484;
            color: white;
        }
        
        #label {
            padding-left: 30px;
        }
        
        .container {
            width: 1300px;
            display: flex;
            padding-left: 50px;
            padding-bottom: 10px;
        }
        
        .left {
            width: 300px;
            height: auto;
            float: left;
        }
        
        .right {
            width: 900px;
            float: left;
            height: auto;
            padding-top: 25px;
            font-size: 15pt;
        }
        
        svg {
            border: solid black 1px;
        }
        
        .svgs {
            width: 1000px;
            display: flex;
            padding-left: 30px;
            padding-bottom: 10px;
        }
        
        #map {
            width: 800px;
            height: auto;
            float: left;
        }
        
        #map-details {
            width: 300px;
            float: left;
            height: auto;
        }

        image {
            border: solid red 1px;
        }
        
        .states {
            fill: none;
            stroke: #fff;
            stroke-linejoin: round;
        }
        
        #svg-map {
            /*background-color: #42647F;*/
            padding-top: 10px;
        }

        #legend {
            text-align: center;
            margin-top: -10px;
        }
    </style>


</head>

<body>
    <h1>Severe Weather Episodes in the U.S.</h1>

    <p style="padding: 0 25px">As of April 6 in 2017, there have been <span id="highlight">5 recorded severe weather disaster events </span> that each caused <span id="highlight">over 1 billion dollars in losses</span>. The disasters resulted in the <span id="highlight">deaths of 37 people</span> and caused significant economic destruction on the areas of impact.</p>
    <p style="padding: 0 25px; margin-top: -17px">Between 1980 and 2016, there was <span id="highlight">an annual average of 5.5 events</span>. Between 2012 and 2016, the <span id="highlight">annual average was 10.6 events</span>.</p>
    <p style="padding: 0 25px; margin-top: -5px">Use the following map to visualize the occurrence of weather events across the US between 1999 and 2016.</p>

    <!-- Instructions -->

    <div style="padding: 0 25px; padding-top: 10px" id="instruct">
        <h3>Instructions</h3>
        <p style="margin-top: -20px">To see weather events on a single day, enter a valid date below to visualize weather pattens. <span style="font-weight: bold">See Weather On </span>any date of your choosing. </p>
        <p style="margin-top: -17px">Witness the influence of weather across the country and <span style="font-weight: bold">Fast Forward Through </span>time utilizing the impact of the forecast. Capture the change of weather episodes between various ranges of dates by entering valid start and end dates below.</p>
    </div>

    <!-- Button sections -->
    <div style="margin-top: -10px" class="container">
        <div class="left">
            <div class="circle">
                <div class="circleText">1</div>
            </div>
            <h2>See Weather On</h2>
        </div>
        <div class="right">
            <input type="date" id="date">
            <button type="button" onclick="visualizeSingleDate()">Visualize</button>
        </div>
    </div>

    <div style="margin-top: -20px" class="container">
        <div class="left">
            <div class="circle">
                <div class="circleText">2</div>
            </div>
            <h2>Fast Forward Through</h2></div>
        <div class="right">
            <span id="label">
    Start Date:</span>
            <input type="date" id="startDate"><span id="label">
    End Date:</span>
            <input type="date" id="endDate">
            <button type="button" onclick="visualizeFastForward()">Visualize</button>
        </div>
    </div>
    
    <h4 style="font-size: 10pt; text-align: center; margin-top: -5px">Credits: Icons retrieved and modified from http://www.freepik.com and https://www.amcharts.com/free-animated-svg-weather-icons</h4>
    <div id="legend"></div>

    <div style="margin-left: -25px; margin-top: -20px" class="svgs">
        <div id="map"><svg id="svg-map"></svg></div>
        <div id="map-details"></div>
    </div>

    <h4 style="font-weight: bold; text-align: center; font-size: 20pt">Top Places You Can Die From A Weather Event</h4>

    <script>
        function visualizeSingleDate() {
            var rawDate= document.getElementById('date').value;
            var userViewDate = new Date(rawDate.replace("-", "/"));

            var svg = d3.select("#svg-map");
            svg.selectAll("image").remove();

            svg.selectAll("image")
                //going through location, note has to be array
                .data(d3.values(locations).filter(function (event) {
                    //console.log(event.EVENT_ID);
                    //console.log(deats[event.EVENT_ID]);
                    var beginDay = new Date(deats[event.EVENT_ID].BEGIN_DATE_TIME).clearTime();

                    var endDay = new Date(deats[event.EVENT_ID].END_DATE_TIME).clearTime();

                    //only filters if returns true
                    return userViewDate.between(beginDay, endDay);

                    //how you would refer to fatatilies
                    //fatal(event.EVENT_ID)...

                })).enter()
                .append("image")
                .attr("x", function (event) {

                    return projection([event.LATITUDE, event.LONGITUDE].reverse())[0] - 17;
                })
                .attr("y", function (event) {
                    return projection([event.LATITUDE, event.LONGITUDE].reverse())[1] - 17;
                })
                .attr("xlink:href", function (event) {
                    return details[event.EVENT_ID].icon;
                })

        }
                
        function visualizeFastForward() {
            var currentStartDate = document.getElementById('startDate').value;
            var currentEndDateVal = document.getElementById('endDate').value;
        }

        var episodeCosts = [];
        var episodeIDs = [];

        var states;
        var deats = {};
        var locations = {};
        var eventsNoCost = [];

        var floodEvents = ["Coastal Flood", "Flash Flood", "Flood", "High Surf", "Tsunami"];
        var hotEvents = ["Wildfire", "Drought", "Dust Storm", "Excessive Heat", "Heat"];
        var snowEvents = ["Winter Storm", "Winter Weather", "Sleet", "Ice Storm", "Heavy Snow", "Blizzard", "Avalanche"];
        var coldEvents = [ "Hail", "Frost/Freeze", "Extreme Cold/Wind Chill", "Cold/Wind Chill"];
        var windEvents = ["High Wind", "Thunderstorm Wind", "Tornado"];
        var hurricanes = ["Hurricane", "Typhoon", "Hurricane (Typhoon)", "Tropical Storm"];

        var water_icon = "icons/static/flood.png",
            fire_icon = "icons/static/heat.png",
            snow_icon = "icons/animated/snowy-6.svg",
            wind_icon = "icons/static/windy.png",
            hurricane_icon = "icons/static/hurr.png",
            weather_icon = "icons/animated/weather.svg",
            cold_icon = "icons/static/cold.png";


        var parseRowDetails = function (row) {
            row.EVENT_ID = Number(row.EVENT_ID);
            //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);

            // row.totalDamage = convertToMonetaryVals(row.DAMAGE_CROPS) +
            //     convertToMonetaryVals(row.DAMAGE_PROPERTY);
            // if (row.totalDamage === 0) {
            //     eventsNoCost.push(row.EVENT_ID);
            //     return;
            // }

            //creating icon row
            if (floodEvents.includes(row.EVENT_TYPE)) {
                row.icon = water_icon;
            } else if (hotEvents.includes(row.EVENT_TYPE)) {
                row.icon = fire_icon;
            } else if (snowEvents.includes(row.EVENT_TYPE)) {
                row.icon = snow_icon;
            } else if (coldEvents.includes(row.EVENT_TYPE)) {
                row.icon = cold_icon;
            } else if (windEvents.includes(row.EVENT_TYPE)) {
                row.icon = wind_icon;
            } else if (hurricanes.includes(row.EVEMT_TYPE)) {
                row.icon = hurricane_icon;
            } else {
                row.icon = weather_icon;
            }


            /*            var daysOfEvent = [];

                        var beginDate = new Date(row.BEGIN_DATE_TIME).clearTime();
                        var endDate = new Date(row.END_DATE_TIME).clearTime();

                        var sameDate = -1;


                        while (sameDate == -1) {
                            daysOfEvent.push(beginDate);
                            if (!beginDate.compare(endDate)) {
                                sameDate = 0;
                            }
                            beginDate.add(1);
                        }

                        row.days = daysOfEvent;*/

            return row;
        }

        var parseRow = function (row) {
            row.EVENT_ID = Number(row.EVENT_ID);
            //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);
            row.LATITUDE = Number(row.LATITUDE);
            row.LONGITUDE = Number(row.LONGITUDE);

            return row;
        }

        // Convert string money value into number
        // function convertToMonetaryVals(string) {
        //     if (string.includes("K")) {
        //         string = string.replace("K", "");
        //         return Number(string) * 1000;
        //     } else if (string.includes("M")) {
        //         string = string.replace("M", "");
        //         return Number(string) * 1000000;
        //     } else {
        //         return string;
        //     }
        // }

        var details;
        var rawDeats = {};


        // Load data from json and csv files
        d3.queue()
            .defer(d3.json, "json/us.json")
            .defer(d3.csv, "csv/ProcessedCSV/2016Condensed.csv", parseRowDetails)
            .defer(d3.csv, "csv/StormEvents_locations-ftp_v1.0_d2016_c20170317.csv", parseRow)

        .await(function (error, rawMap, rawDetails, rawLocations) {

            rawDeats = rawDetails;
            states = (topojson.feature(rawMap, rawMap.objects.states)).features;

            rawDetails.forEach(function (detail) {
                deats[detail.EVENT_ID] = detail;
            })



            rawLocations.forEach(function (location) {
                if (deats.hasOwnProperty(location.EVENT_ID)) {
                    locations[location.EVENT_ID] = location;
                }

                
            })

            //deleting events from location array that have zero cost associated with them
            eventsNoCost.forEach(function (event) {
                if (locations.hasOwnProperty(event)) {
                    delete locations[event];
                }
            })

            createMap();
            details = deats;


        });

        d3.values(locations).forEach(function (event) {
            if (!episodeIDs.includes(event.EPISODE_ID)) {
                episodeIDs.push(event.EPISODE_ID);

            }

            episodeCosts[episodeIDs.indexOf(event.EPISODE_ID)] = episodeCosts[episodeIDs.indexOf(event.EPISODE_ID)] + deats(event.EVENT_ID).totalDamage;

        });

        // Create map of USA
        var width = 800,
            height = 540;
        var projection = d3.geoAlbersUsa().scale(1080).translate([width / 2, height / 2]);
        var path = d3.geoPath().projection(projection);
        var lwidth = 1200,
            lheight = 100;

        function createMap() {
            //var projection = d3.geoAlbersUsa().scale(1080).translate([width / 2, height / 2]);
            //var path = d3.geoPath().projection(projection);

            var svg = d3.select("#svg-map")
                .attr("width", width)
                .attr("height", height);

            svg.append("g").attr("class", "states")
                .selectAll("path")
                .data(states).enter()
                .append("path")
                .style("fill", "#77DD77")
                .attr("d", path);


            //!!!!!!!!!!!!!! icons to map!!!!!!!!!!!//

            ////////////////////////////////////////
            //make sure this goes to function that is called upon user input
            // svg.selectAll("image")
            //     //going through location, note has to be array
            //     .data(d3.values(locations).filter(function (event) {
            //         console.log(event.EVENT_ID);
            //         console.log(deats[event.EVENT_ID]);
            //         var beginDay = new Date(deats[event.EVENT_ID].BEGIN_DATE_TIME).clearTime();

            //         var endDay = new Date(deats[event.EVENT_ID].END_DATE_TIME).clearTime();


            //         //
            //         var userDate = new Date("08/08/2016");



            //         //only filters if returns true
            //         return userDate.between(beginDay, endDay);

            //         //how you would refer to fatatilies
            //         //fatal(event.EVENT_ID)...

            //     })).enter()
            //     .append("image")
            //     .attr("x", function (event) {

            //         return projection([event.LATITUDE, event.LONGITUDE].reverse())[0] - 17;
            //     })
            //     .attr("y", function (event) {
            //         return projection([event.LATITUDE, event.LONGITUDE].reverse())[1] - 17;
            //     })
            //     .attr("xlink:href", function (event) {

            //         return deats[event.EVENT_ID].icon;
            //     })

        };


        var dsvg = d3.select("#map-details").append("svg")
            .attr("width", width * 0.65)
            .attr("height", height);

        // Create map legend
        var lsvg = d3.select("#legend").append("svg")
            .attr("width", lwidth)
            .attr("height", lheight);
        var icon_lst = [water_icon, fire_icon, snow_icon, cold_icon, wind_icon, hurricane_icon, weather_icon];
        for (var i = 0; i < 7; i++) {
            lsvg.append("image")
                .attr("x", (i*170)+70)
                .attr("y", 0)
                .attr("xlink:href", icon_lst[i])
                .attr("class", "i");

            if (icon_lst[i] == water_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+50).attr("y", 70)
                    .text("Extreme Flooding");
                lsvg.append("text")
                    .attr("x", (i*170)+45).attr("y", 90)
                    .text("(ex. floods, tsunami)");
            } else if (icon_lst[i] == fire_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+60).attr("y", 70)
                    .text("Blazing Heat");
                lsvg.append("text")
                    .attr("x", (i*170)+30).attr("y", 90)
                    .text("(ex. wildfire, drought)");
            } else if (icon_lst[i] == snow_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+45).attr("y", 70)
                    .text("Snow Catastrophes");
                lsvg.append("text")
                    .attr("x", (i*170)+30).attr("y", 90)
                    .text("(ex. blizzard, avalanche)");
            } else if (icon_lst[i] == cold_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+65).attr("y", 70)
                    .text("Deep Freeze");
                lsvg.append("text")
                    .attr("x", (i*170)+60).attr("y", 90)
                    .text("(ex. hail, frost)");
            } else if (icon_lst[i] == wind_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+65).attr("y", 70)
                    .text("Stormy Winds");
                lsvg.append("text")
                    .attr("x", (i*170)+30).attr("y", 90)
                    .text("(ex. tornado, storm winds)");
            } else if (icon_lst[i] == hurricane_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+60).attr("y", 70)
                    .text("Coastal Calamity");
                lsvg.append("text")
                    .attr("x", (i*170)+35).attr("y", 90)
                    .text("(ex. hurricane, typhoon)");
            } else if (icon_lst[i] == weather_icon) {
                lsvg.append("text")
                    .attr("x", (i*170)+60).attr("y", 70)
                    .text("Miscellaneous");
                lsvg.append("text")
                    .attr("x", (i*170)+63).attr("y", 90)
                    .text("(ex. lightning)");
            }
        }

    </script>

</body>

</html>