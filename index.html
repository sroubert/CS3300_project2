<!DOCTYPE html>

<html>

<!-- sr949, dc652, kat86 Project 2 -->

<head>

    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/weather-icons.min.css">
    <!-- Weather icons from https://github.com/erikflowers/weather-icons -->
    <title>CS 3300 Project 2</title>

    <link type="text/css" rel="stylesheet" href="https://fast.fonts.net/cssapi/c1ece602-4b8f-4767-a71f-aa828be38869.css" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

    <style>
        body {
            font-family: "LinotypeUniversW01-Cn";
            padding: 10px 0;
            background-color: #eeeeee;
        }
        
        h1 {
            font-family: "LinotypeUniversW01-Cn";
            text-transform: uppercase;
            font-weight: 600;
            font-size: 35pt;
            padding: 0;
            margin: 0;
            padding-top: 10px;
            line-height: 1.2em;
            text-align: center;
        }
        
        h2 {
            text-align: left;
            padding-top: 10px;
        }
        
        h3 {
            font-family: "LinotypeUniversW01-Cn";
            text-transform: uppercase;
            font-weight: 500;
            font-size: 25pt;
        }
        
        p {
            font-size: 15pt;
        }
        
        #instruct {
            text-align: left;
            padding-left: 10px;
            padding-bottom: 0;
        }
        
        div.circle {
            width: 40px;
            height: 40px;
            border: solid #585858 2px;
            border-radius: 30px;
            color: #585858;
            text-align: center;
            font-size: 32px;
            margin: 23px 20px 0 0;
            float: left;
            font-weight: bold;
        }
        
        div.circleText {
            padding-top: 3px;
        }
        
        #label {
            padding-left: 25px;
        }
        
        .container {
            width: 1000px;
            display: flex;
            padding-left: 50px;
            padding-bottom: 10px;
        }
        
        .left {
            width: 300px;
            height: auto;
            float: left;
        }
        
        .right {
            width: 700px;
            float: left;
            height: auto;
            padding-top: 35px;
        }
        
        svg {
            border: solid black 1px;
        }
        
        .svgs {
            width: 1000px;
            display: flex;
            padding-left: 30px;
            padding-bottom: 10px;
        }
        
        #map {
            width: 800px;
            height: auto;
            float: left;
        }
        
        #map-details {
            width: 300px;
            float: left;
            height: auto;
        }
        
        .states {
            fill: none;
            stroke: #fff;
            stroke-linejoin: round;
        }
        
        .svg-map {
            /*background-color: #42647F;*/
            padding-top: 10px;
        }
    </style>


</head>

<body>
    <h1>Severe Weather Episodes in the US</h1>

    <p style="padding: 0 25px">As of April 6 in 2017, there have been 5 recorded severe weather disaster events that each caused over 1 billion dollars in losses. The disasters resulted in the deaths of 37 people and caused significant economic destruction on the areas of impact.</p>
    <p style="padding: 0 25px; margin-top: -17px">Between 1980 and 2016, there was an annual average of 5.5 events. Between 2012 and 2016, the annual average was 10.6 events.</p>
    <p style="padding: 0 25px; margin-top: -5px">Use the following map to visualize the occurrence of weather events across the US between 1999 and 2016.</p>

    <!-- Instructions -->
    <div style="padding: 0 25px" id="instruct">
    <h3>Instructions</h3>
    <p style="margin-top: -20px">To see weather events on a single day, enter a valid date below to visualize weather pattens. <span style="font-weight: bold">See Weather On </span>any date of your choosing. </p>
    <p style="margin-top: -17px">Witness the influence of weather across the country and <span style="font-weight: bold">Fast Forward Through </span>time via the weather. Visualize the change of weather episodes between various ranges of dates by entering valid start and end dates below.</p>
    </div>

    <!-- Button sections -->
    <div style="margin-top: -10px" class="container">
        <div class="left">
            <div class="circle">
                <div class="circleText">1</div>
            </div>
            <h2>See Weather On</h2>
        </div>
        <div class="right">
            <input type="date" id="date">
            <button type="button" onclick="extractDates()">Visualize Weather Patterns</button>
        </div>
    </div>

    <div style="margin-top: -20px" class="container">
        <div class="left">
            <div class="circle">
                <div class="circleText">2</div>
            </div>
            <h2>Fast Forward Through</h2></div>
        <div class="right">
            <span id="label">
    Start Date:</span>
            <input type="date" id="startDate"><span id="label">
    End Date:</span>
            <input type="date" id="endDate">
            <button type="button" onclick="extractDates()">Visualize Weather Patterns</button>
        </div>
    </div>


    <div style="margin-left: -25px" class="svgs">
        <div id="map"></div>
        <div id="map-details"></div>
    </div>

    <h4 style="font-weight: bold; text-align: center; font-size: 20pt">Top Places You Can Die From A Weather Event</h4>
    <script>
        function extractDates() {
            var currentStartDate = document.getElementById('startDate').value;
            var currentEndDateVal = document.getElementById('endDate').value;
        }

        var episodeCosts = [];
        var episodeIDs = [];

        var states;
        var deats = {};
        var locations = {};
        var eventsNoCost = [];

        var floodEvents = ["Coastal Flood", "Flash Flood", "Flood", "High Surf", "Tsunami"];
        var hotEvents = ["Wildfire", "Drought", "Dust Storm", "Excessive Heat", "Heat"];
        var snowEvents = ["Winter Storm", "Winter Weather", "Sleet", "Ice Storm", "Heavy Snow",
                        "Hail", "Frost/Freeze", "Extreme Cold/Wind Chill", "Cold/Wind Chill",
                        "Blizzard", "Avalanche"];
        var windEvents = ["High Wind", "Thunderstorm Wind", "Tornado"];
        var hurricanes = ["Hurricane", "Typhoon", "Hurricane (Typhoon)", "Tropical Storm"];


        var parseRowDetails = function (row) {
            row.EVENT_ID = Number(row.EVENT_ID);
            //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);

            row.totalDamage = convertToMonetaryVals(row.DAMAGE_CROPS) +
                convertToMonetaryVals(row.DAMAGE_PROPERTY);
            if (row.totalDamage === 0) {
                eventsNoCost.push(row.EVENT_ID);
                return;
            }

            //creating icon row
            if (floodEvents.includes(row.EVENT_TYPE)) {
                row.icon = "icons/static/water.png";
            } else if (hotEvents.includes(row.EVENT_TYPE)) {
                row.icon = "icons/static/fire.png";
            } else if (snowEvents.includes(row.EVENT_TYPE)) {
                row.icon = "icons/static/snow.png";
            } else if (windEvents.includes(row.EVENT_TYPE)) {
                row.icon = "icons/static/wind.png";
            } else if (hurricanes.includes(row.EVEMT_TYPE)) {
                row.icon = "icons/static/hurricane.png";
            } else {
                row.icon = "icons/animated/night.svg";
            }



            return row;
        }

        var parseRow = function (row) {
            row.EVENT_ID = Number(row.EVENT_ID);
            //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);
            row.LATITUDE = Number(row.LATITUDE);
            row.LONGITUDE = Number(row.LONGITUDE);

            return row;
        }

        // Convert string money value into number
        function convertToMonetaryVals(string) {
            if (string.includes("K")) {
                string = string.replace("K", "");
                return Number(string) * 1000;
            } else if (string.includes("M")) {
                string = string.replace("M", "");
                return Number(string) * 1000000;
            } else {
                return string;
            }
        }

        var details;
        var eventTypes = [];


        // Load data from json and csv files
        d3.queue()
            .defer(d3.json, "json/us.json")
            .defer(d3.csv, "csv/StormEvents_details_d2016_steamlined_first.csv", parseRowDetails)
            .defer(d3.csv, "csv/StormEvents_locations-ftp_v1.0_d2016_c20170317.csv", parseRow)

        .await(function (error, rawMap, rawDetails, rawLocations) {

            states = (topojson.feature(rawMap, rawMap.objects.states)).features;

            rawDetails.forEach(function (detail) {
                deats[detail.EVENT_ID] = detail;
            })



            rawLocations.forEach(function (location) {
                locations[location.EVENT_ID] = location;
            })

            //deleting events from location array that have zero cost associated with them
            eventsNoCost.forEach(function (event) {
                if (locations.hasOwnProperty(event)) {
                    delete locations[event];
                }
            })

            createMap();
            details = deats;

            d3.values(deats).forEach(function (event) {
                    if (!eventTypes.includes(event.EVENT_TYPE)) {
                        eventTypes.push(event.EVENT_TYPE);
                    }
                }


            );

            console.log(eventTypes);
        });

        d3.values(locations).forEach(function (event) {
            if (!episodeIDs.includes(event.EPISODE_ID)) {
                episodeIDs.push(event.EPISODE_ID);

            }

            episodeCosts[episodeIDs.indexOf(event.EPISODE_ID)] = episodeCosts[episodeIDs.indexOf(event.EPISODE_ID)] + deats(event.EVENT_ID).totalDamage;

        });

        // Create map of USA
        var width = 800,
            height = 520;

        function createMap() {
            var projection = d3.geoAlbersUsa().scale(1080).translate([width/2, height/2]);
            var path = d3.geoPath().projection(projection);

            var svg = d3.select("#map").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "svg-map");

            svg.append("g").attr("class", "states")
                .selectAll("path")
                .data(states).enter()
                .append("path")
                .style("fill", "#77DD77")
                .attr("d", path);

            svg.append("image").attr("xlink:href", "icons/animated/cloudy-day-2.svg")
                .attr("x", "100")
                .attr("y", "100");

            svg.selectAll("image")
                .data(d3.values(locations).filter(function (event) {

                    return ((projection([event.LATITUDE, event.LONGITUDE].reverse())) != null) && deats[event.EVENT_ID].BEGIN_DAY === "8" && deats[event.EVENT_ID].BEGIN_YEARMONTH === "201608";

                })).enter()
                .append("image")
                .attr("x", function (event) {

                    // console.log(event.EVENT_ID)


                    return projection([event.LATITUDE, event.LONGITUDE].reverse())[0] - 17;
                })
                .attr("y", function (event) {
                    return projection([event.LATITUDE, event.LONGITUDE].reverse())[1] - 17;
                })
                .attr("xlink:href", function (event) {

                    console.log(deats[event.EVENT_ID].icon);
                    return deats[event.EVENT_ID].icon;
                })
        };


        var dsvg = d3.select("#map-details").append("svg")
            .attr("width", width * 0.65)
            .attr("height", height)
    </script>

</body>

</html>