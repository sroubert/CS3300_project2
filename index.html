<!DOCTYPE html>

<html>

<!-- sr949, dc652, kat86 Project 2 -->

<head>

    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/weather-icons.min.css">
    <!-- Weather icons from https://github.com/erikflowers/weather-icons -->
    <title>CS 3300 Project 2</title>

    <link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <link type="text/css" href="../codebase/dhtmlxcalendar.css">
    <script src="../codebase/dhtmlxcalendar.js"></script>
    <link rel="stylesheet" href="http://cdn.dhtmlx.com/edge/dhtmlx.css" 
    type="text/css"> 
    <script src="http://cdn.dhtmlx.com/edge/dhtmlx.js" 
    type="text/javascript"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

    <style>
        svg {
            border: solid black 1px;
        }

        i {
        	color: gold;
        }

        .states {
            fill: none;
            stroke: #fff;
            stroke-linejoin: round;
        }

        #test {
        	background-color: yellow;
        }

    </style>


</head>

<body>

    <i class="wi wi-day-sunny"></i>
    
    <div id="map"></div> 
    <svg id="test"><image src="icons/static/fire.png" /></svg> 
    
    <!-- User input dates for slider -->
    <br>
    Start Date:
    <input type="date" id="startDate">
    <br>
    End Date:
    <input type="date" id="endDate">
    <br>
    <button type="button" onclick = "extractDates()" >Visualize Weather Patterns</button>

    <script>
    function extractDates () {
    var currentStartDate = document.getElementById('startDate').value;
    var currentEndDateVal = document.getElementById('endDate').value;
    console.log(currentStartDate);
    }

    var states;
    var deats = {};
    var locations = {};
    var eventsNoCost = [];
        
    var parseRowDetails = function (row) {
	    row.EVENT_ID = Number(row.EVENT_ID);
        //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);

        row.totalDamage = convertToMonetaryVals(row.DAMAGE_CROPS) +
                            convertToMonetaryVals(row.DAMAGE_PROPERTY);
        if (row.totalDamage === 0) { eventsNoCost.push(row.EVENT_ID); return; }
        
	    return row;
    }

        var parseRow= function (row) {
        row.EVENT_ID = Number(row.EVENT_ID);
        //row.DAMAGE_CROPS = convertToMonetaryVals(row.DAMAGE_CROPS);

        return row;
    }

    // Convert string money value into number
    function convertToMonetaryVals(string) {
        if (string.includes("K")) {
            string = string.replace("K", ""); return Number(string) * 1000;
        } else if (string.includes("M")) {
            string = string.replace("M", ""); return Number(string) * 1000000;
        } else {
            return string; 
        }
    }
    
    var details;
        
        

    // Load data from json and csv files
    d3.queue()
    .defer(d3.json, "json/us.json")
    .defer(d3.csv, "csv/StormEvents_details_d2016_steamlined_first.csv", parseRowDetails)
    .defer(d3.csv, "csv/StormEvents_locations-ftp_v1.0_d2016_c20170317.csv", parseRow)

    .await(function (error, rawMap, rawDetails, rawLocations) {

    	states = (topojson.feature(rawMap, rawMap.objects.states)).features;
    	
        rawDetails.forEach(function(detail) {
    		deats[detail.EVENT_ID] = detail;
    	})

        
        
    	rawLocations.forEach(function(location) {
    		locations[location.EVENT_ID] = location;
    	})
        
        //deleting events from location array that have zero cost associated with them
        eventsNoCost.forEach(function(event){
            if (locations.hasOwnProperty(event)) {
                delete locations[event];
            } 
        })

    	createMap();
        details= deats;
        

    });

    // Create map of USA
    var width = 960,
        height = 500;
    function createMap() {
    	var projection = d3.geoAlbersUsa().scale(1070).translate([width/2, height/2]);
    	var path = d3.geoPath().projection(projection);

    	var svg = d3.select("#map").append("svg")
    	    .attr("width", width)
    	    .attr("height", height);

    	svg.append("g").attr("class", "states")
    	    .selectAll("path")
    	    .data(states).enter()
    	    .append("path")
    	    .style("fill", "#77DD77")
    	    .attr("d", path);

    	var svgtest = d3.select("#test");
    	svg.append("image").attr("xlink:href", "icons/animated/cloudy-day-2.svg")
    	    .attr("x", "100")
    	    .attr("y", "100");
    	svg.append("image").attr("xlink:href", "icons/static/flood.png")
    	    .attr("x", "50")
    	    .attr("y", "50");

    	aa = [-122.490402, 37.786453];
    	svg.selectAll("circle")
		.data([aa]).enter()
		.append("image").attr("xlink:href", "icons/static/cold.png")
		.attr("x", function (d) { console.log(d); return projection(d)[0]; })
		.attr("y", function (d) { return projection(d)[1]; })
		.attr("class", "icon");

		svg.selectAll("circle")
		.data([aa]).enter()
		.append("circle")
		.attr("cx", function (d) { console.log(d); return projection(d)[0]; })
		.attr("cy", function (d) { return projection(d)[1]; })
		.attr("r", "8px")
		.attr("fill", "red");

		svgtest.append("image").attr("xlink:href", "icons/static/flood.png")
    	    .attr("class", "icon")
    	    .attr("x", "0")
    	    .attr("y", "0");

    }

    </script>

</body>

</html>